

[delayed_gcode bed_safety_gcode]
initial_duration: 5.
gcode:
  {% if printer.heater_bed.target > 0 %}
    {% if printer['output_pin bed_safety_switch'].value|int == 0 %}
      SET_PIN PIN=bed_safety_switch VALUE=1
      M117 Safety Switch ON - via gcode
    {% endif %}
  {% else %}
    {% if printer['output_pin bed_safety_switch'].value|int == 1 %}
      SET_PIN PIN=bed_safety_switch VALUE=0
      M117 Safety Switch OFF - via gcode
    {% endif %}
  {% endif %}
  M117 test
  UPDATE_DELAYED_GCODE ID=bed_safety_gcode DURATION=5

[gcode_macro M140]
rename_existing: M140.1 
gcode: 
  {% if rawparams %}
    {% set sp_temp = rawparams.split('S', 1)[1] %} 
    {% set sp_temp = sp_temp.split(' ', 1)[0] %} 
    {% if sp_temp|int == 0 %}
      SET_PIN PIN=bed_safety_switch VALUE=0
      M117 Safety Switch OFF - Command sent with 0 temp
      M117 { sp_temp } 
      M117 { sp_temp|int } 
    {% else %}
      SET_PIN PIN=bed_safety_switch VALUE=1
      M117 Safety Switch ON
    {% endif %}
    M140.1 { rawparams }
  {% else %}
    SET_PIN PIN=bed_safety_switch VALUE=0
    M117 Safety Switch OFF - No rawparams
    M140.1
  {% endif %} 
  

[gcode_macro M190]
rename_existing: M190.1 
gcode: 
  {% if rawparams %}   
    {% set sp_temp_2 = rawparams[0:rawparams.lower().find("s")].rstrip() %}
    M117 {sp_temp_2}
    {% set sp_temp = rawparams.split('S', 1)[1] %} 
    {% if sp_temp|int == 0 %}
      SET_PIN PIN=bed_safety_switch VALUE=0
      M117 Safety Switch OFF - Command sent with 0 temp
    {% else %}
      SET_PIN PIN=bed_safety_switch VALUE=1
      M117 Safety Switch ON
    {% endif %}
  {% else %}
    SET_PIN PIN=bed_safety_switch VALUE=0
    M117 Safety Switch OFF - No rawparams
  {% endif %} 
  M190.1 { rawparams }

[gcode_macro SET_HEATER_TEMPERATURE]
rename_existing: _SET_HEATER_TEMPERATURE
gcode:
  {% set p_setpoint = rawparams.split('TARGET=', 1)[1] %}
  RESPOND TYPE=command MSG='{p_setpoint}'
  {% if rawparams.find('heater_bed')|int > 0  %}
    {% if p_setpoint|int > 0 %}
      SET_PIN PIN=bed_safety_switch VALUE=1
      M117 Safety Switch ON
    {% else %}
      SET_PIN PIN=bed_safety_switch VALUE=0
      M117 Safety Switch OFF - command sent with 0 value
    {% endif %}
  {% endif %}
  _SET_HEATER_TEMPERATURE { rawparams }
